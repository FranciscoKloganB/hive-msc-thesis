<!DOCTYPE html>
<html lang="en" >
<head>
    <meta charset="utf-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <title>app.domain.network_nodes</title>
    

    <link rel="stylesheet" href="../../../_static/css/redactor.css" type="text/css" />
    
    
    <link rel="index" title="Index" href="../../../genindex.html"/>
    <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="Hives - P2P Stochastic Swarm Guidance Simulator" href="../../../index.html"/>
    <link rel="up" title="Module code" href="../../index.html"/> 
</head>

<body role="document">
     

    
<a href="#" id="js-navigation-toggle" class="navigation-toggle">
    <i class="mdi mdi-menu"></i><i class="mdi mdi-close"></i>
</a>

<section class="site-sidebar">

<nav>


    <a href="../../../index.html" class="branding-link">
    
        Hives
    
    
    
        
        
            <span class="branding-link__version">
                1.6
            </span>
        
    
    </a>

    
<section role="search">
    <form action="../../../search.html" method="get" class="site-searchform">
        <input type="text" name="q" placeholder="Search docs" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
</section>



    <section class="site-nav">
    
    
        <p class="caption"><span class="caption-text">Navbar</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstartdocs.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scriptdocs.html">Scripts and Flags</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../app.html">App Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notedocs.html">Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../indices.html">Indices</a></li>
</ul>

    
    </section>

</nav>

</section>

    <main class="site-main" role="main">
        











<nav class="site-breadcrumbs">
    <ul>
    
        <li>
            <a href="../../../index.html">Docs</a> /
        </li>
        
        <li>
            <a href="../../index.html">Module code</a> /
        </li>
        
        <li class="site-breadcrumbs__leaf">app.domain.network_nodes</li>
    
    </ul>
</nav>
        <section class="site-content">
            <div class="container">
                
  <h1>Source code for app.domain.network_nodes</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;This module contains domain specific classes that represent network nodes</span>
<span class="sd">responsible for the storage of file blocks. These could be reliable servers</span>
<span class="sd">or P2P nodes.&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>

<span class="kn">import</span> <span class="nn">domain.helpers.smart_dataclasses</span> <span class="k">as</span> <span class="nn">sd</span>
<span class="kn">import</span> <span class="nn">domain.helpers.enums</span> <span class="k">as</span> <span class="nn">e</span>
<span class="kn">import</span> <span class="nn">domain.master_servers</span> <span class="k">as</span> <span class="nn">ms</span>
<span class="kn">import</span> <span class="nn">type_hints</span> <span class="k">as</span> <span class="nn">th</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">crypto</span>
<span class="kn">from</span> <span class="nn">environment_settings</span> <span class="kn">import</span> <span class="n">TRUE_FALSE</span>


<div class="viewcode-block" id="Node"><a class="viewcode-back" href="../../../app.domain.html#app.domain.network_nodes.Node">[docs]</a><span class="k">class</span> <span class="nc">Node</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;This class contains basic network node functionality that should</span>
<span class="sd">    always be useful.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        id:</span>
<span class="sd">            A unique identifier of the worker instance on the network.</span>
<span class="sd">            It could be an UUID, a username or an IP-Address.</span>
<span class="sd">        uptime:</span>
<span class="sd">            The amount of time the worker is expected to remain online</span>
<span class="sd">            without disconnection. Current uptime implementation is based on</span>
<span class="sd">            availability percentages. Furthermore, when a HiveNode joins</span>
<span class="sd">            an Cluster as a replacement for some other HiveNode, in</span>
<span class="sd">            :py:meth:`app.domain.cluster_groups.Cluster._membership_maintenance`</span>
<span class="sd">            , the time the worker has been online is not considered. Thus,</span>
<span class="sd">            if a HiveNode belongs to only one Cluster he is guaranteed to</span>
<span class="sd">            remain online for exactly `uptime` *</span>
<span class="sd">            :py:attr:`environment_settings.MAX_EPOCHS`. If he belongs to</span>
<span class="sd">            multiple Hives in the simulation, than there is a possibility</span>
<span class="sd">            that he may go offline earlier.</span>
<span class="sd">        status:</span>
<span class="sd">            Indicates if the ``Node`` instance is online or offline. In later</span>
<span class="sd">            releases this could also contain a &#39;suspect&#39; status. See</span>
<span class="sd">            :py:class:`app.domain.helpers.enums.Status`.</span>
<span class="sd">        suspicious_replies:</span>
<span class="sd">            Set that contains :py:class:`app.domain.helpers.enums.HttpCodes`</span>
<span class="sd">            that trigger complaints to monitors.</span>
<span class="sd">        files:</span>
<span class="sd">            A dictionary mapping file names to file block identifiers and their</span>
<span class="sd">            respective contents. This collection represents the file block</span>
<span class="sd">            blocks that are currently hosted in the HiveNode instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Node.__init__"><a class="viewcode-back" href="../../../app.domain.html#app.domain.network_nodes.Node.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">uptime</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Instantiates a HiveNode object.</span>

<span class="sd">        Workers are the network nodes responsible for persisting file block</span>
<span class="sd">        blocks.</span>

<span class="sd">        Args:</span>
<span class="sd">            uid:</span>
<span class="sd">                An unique identifier for the worker instance.</span>
<span class="sd">            uptime:</span>
<span class="sd">                The availability of the worker instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">uptime</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">uptime</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">uptime</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">uptime</span> <span class="o">*</span> <span class="n">ms</span><span class="o">.</span><span class="n">Master</span><span class="o">.</span><span class="n">MAX_EPOCHS</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">uid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uptime</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">uptime</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">ONLINE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_replies</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">e</span><span class="o">.</span><span class="n">HttpCodes</span><span class="o">.</span><span class="n">NOT_FOUND</span><span class="p">,</span>
            <span class="n">e</span><span class="o">.</span><span class="n">HttpCodes</span><span class="o">.</span><span class="n">TIME_OUT</span><span class="p">,</span>
            <span class="n">e</span><span class="o">.</span><span class="n">HttpCodes</span><span class="o">.</span><span class="n">SERVER_DOWN</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">th</span><span class="o">.</span><span class="n">ReplicasDict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span></div>

    <span class="c1"># region Simulation steps</span>
<div class="viewcode-block" id="Node.execute_epoch"><a class="viewcode-back" href="../../../app.domain.html#app.domain.network_nodes.Node.execute_epoch">[docs]</a>    <span class="k">def</span> <span class="nf">execute_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cluster</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">ClusterType</span><span class="p">,</span> <span class="n">fid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Instructs the HiveNode instance to execute the epoch.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError:</span>
<span class="sd">                When the class or one of its children does not implement</span>
<span class="sd">                their own `execute_epoch` method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;All children of class Node must &quot;</span>
                                  <span class="s2">&quot;implement their own execute_epoch.&quot;</span><span class="p">)</span></div>
    <span class="c1"># endregion</span>

    <span class="c1"># region File block management</span>
<div class="viewcode-block" id="Node.receive_part"><a class="viewcode-back" href="../../../app.domain.html#app.domain.network_nodes.Node.receive_part">[docs]</a>    <span class="k">def</span> <span class="nf">receive_part</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">replica</span><span class="p">:</span> <span class="n">sd</span><span class="o">.</span><span class="n">FileBlockData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Endpoint for file block replica reception.</span>

<span class="sd">        Invoking this method results in the worker keeping store a new</span>
<span class="sd">        file block replica in his :py:attr:`files` collection, along the ones</span>
<span class="sd">        already there.</span>

<span class="sd">        Args:</span>
<span class="sd">            replica:</span>
<span class="sd">               The file block container to be received by the worker instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">             An HTTP code defined in</span>
<span class="sd">             :py:class:`domain.helpers.enums.HttpCodes`. If upon integrity</span>
<span class="sd">             verification the sha256 hashvalue differs from the expected,</span>
<span class="sd">             the worker replies with a BAD_REQUEST code. If the HiveNode already</span>
<span class="sd">             owns a replica with the same number identifier it</span>
<span class="sd">             replies with NOT_ACCEPTABLE. Otherwise it replies with a OK,</span>
<span class="sd">             i.e., the delivery is successful.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">replica</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="c1"># init dict that accepts &lt;key: id, value: sfp&gt; pairs for the file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">replica</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">crypto</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">replica</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="n">replica</span><span class="o">.</span><span class="n">sha256</span><span class="p">:</span>
            <span class="c1"># inform sender that his part is corrupt,</span>
            <span class="c1"># don&#39;t initiate recovery protocol - avoid DoS at current worker.</span>
            <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="n">HttpCodes</span><span class="o">.</span><span class="n">BAD_REQUEST</span>
        <span class="k">elif</span> <span class="n">replica</span><span class="o">.</span><span class="n">number</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">replica</span><span class="o">.</span><span class="n">name</span><span class="p">]:</span>
            <span class="c1"># reject repeated blocks even if they are correct</span>
            <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="n">HttpCodes</span><span class="o">.</span><span class="n">NOT_ACCEPTABLE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># accepted file part</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">replica</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">replica</span><span class="o">.</span><span class="n">number</span><span class="p">]</span> <span class="o">=</span> <span class="n">replica</span>
            <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="n">HttpCodes</span><span class="o">.</span><span class="n">OK</span></div>

<div class="viewcode-block" id="Node.replicate_part"><a class="viewcode-back" href="../../../app.domain.html#app.domain.network_nodes.Node.replicate_part">[docs]</a>    <span class="k">def</span> <span class="nf">replicate_part</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cluster</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">ClusterType</span><span class="p">,</span> <span class="n">replica</span><span class="p">:</span> <span class="n">sd</span><span class="o">.</span><span class="n">FileBlockData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Tries to restore the `replica`&#39;s</span>
<span class="sd">        :py:const:`environment_settings.REPLICATION_LEVEL`.</span>

<span class="sd">        Similar to :py:meth:`domain.network_nodes.Node.send_part` but with</span>
<span class="sd">        slightly different instructions. In particular newly replicate</span>
<span class="sd">        replicas can not be corrupted at the current node, at the current epoch.</span>

<span class="sd">        Args:</span>
<span class="sd">            cluster:</span>
<span class="sd">                Gateway Cluster that will deliver the file block replica to</span>
<span class="sd">                some destination HiveNode.</span>
<span class="sd">            replica:</span>
<span class="sd">                The file block replica to be delivered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Node.send_part"><a class="viewcode-back" href="../../../app.domain.html#app.domain.network_nodes.Node.send_part">[docs]</a>    <span class="k">def</span> <span class="nf">send_part</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                  <span class="n">cluster</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">ClusterType</span><span class="p">,</span>
                  <span class="n">destination</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">replica</span><span class="p">:</span> <span class="n">sd</span><span class="o">.</span><span class="n">FileBlockData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">th</span><span class="o">.</span><span class="n">HttpResponse</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Attempts to send a replica to some other network node.</span>

<span class="sd">        Args:</span>
<span class="sd">            cluster:</span>
<span class="sd">                :py:mod:`Cluster Group Monitor &lt;domain.cluster_groups&gt;` that</span>
<span class="sd">                will act as a courier for the message to be sent. In a real</span>
<span class="sd">                world implementation this argument would not be needed and</span>
<span class="sd">                would not even make sense, but we use it to facilitate</span>
<span class="sd">                simulation management and environment logging.</span>
<span class="sd">            destination:</span>
<span class="sd">                The name, address or another unique identifier of the node</span>
<span class="sd">                that will receive the file block `replica`.</span>
<span class="sd">            replica:</span>
<span class="sd">                The file block container to be sent to some other worker.</span>

<span class="sd">        Returns:</span>
<span class="sd">             An HTTP code defined in</span>
<span class="sd">             :py:class:`domain.helpers.enums.HttpCodes` and the destination</span>
<span class="sd">             the part was sent to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cluster</span><span class="o">.</span><span class="n">route_part</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">replica</span><span class="p">)</span></div>

<div class="viewcode-block" id="Node.discard_part"><a class="viewcode-back" href="../../../app.domain.html#app.domain.network_nodes.Node.discard_part">[docs]</a>    <span class="k">def</span> <span class="nf">discard_part</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">fid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                     <span class="n">number</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                     <span class="n">corrupt</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                     <span class="n">cluster</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">ClusterType</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Safely deletes a part from the HiveNode instance&#39;s disk.</span>

<span class="sd">        Args:</span>
<span class="sd">            fid:</span>
<span class="sd">                Name of the file the file block replica belongs to.</span>
<span class="sd">            number:</span>
<span class="sd">                The part number that uniquely identifies the file block.</span>
<span class="sd">            corrupt:</span>
<span class="sd">                optional; If discard is being invoked due to identified file</span>
<span class="sd">                block corruption, e.g., Sha256 does not match the expected (</span>
<span class="sd">                default False).</span>
<span class="sd">            cluster:</span>
<span class="sd">                Gateway Cluster that will set the recovery epoch (see</span>
<span class="sd">                :py:meth:`domain.cluster_groups.Cluster.set_recovery_epoch`</span>
<span class="sd">                or mark the simulation as failed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">replica</span><span class="p">:</span> <span class="n">sd</span><span class="o">.</span><span class="n">FileBlockData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">replica</span> <span class="ow">and</span> <span class="n">corrupt</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">replica</span><span class="o">.</span><span class="n">decrement_and_get_references</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cluster</span><span class="o">.</span><span class="n">set_replication_epoch</span><span class="p">(</span><span class="n">replica</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cluster</span><span class="o">.</span><span class="n">_set_fail</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Lost last file block replica with id &quot;</span>
                                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">replica</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> due to corruption.&quot;</span><span class="p">)</span></div>
    <span class="c1"># endregion</span>

    <span class="c1"># region Get methods</span>
<div class="viewcode-block" id="Node.get_file_parts"><a class="viewcode-back" href="../../../app.domain.html#app.domain.network_nodes.Node.get_file_parts">[docs]</a>    <span class="k">def</span> <span class="nf">get_file_parts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">th</span><span class="o">.</span><span class="n">ReplicasDict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Gets collection of file parts that correspond to the named file.</span>

<span class="sd">        Args:</span>
<span class="sd">            fid:</span>
<span class="sd">                The identifier that designates the file block blocks</span>
<span class="sd">                the caller wishes to obtain from the HiveNode instance.</span>

<span class="sd">        Returns:</span>
<span class="sd">             A collection that maps file block identifiers to file block</span>
<span class="sd">             containers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="p">{})</span></div>

<div class="viewcode-block" id="Node.get_file_parts_count"><a class="viewcode-back" href="../../../app.domain.html#app.domain.network_nodes.Node.get_file_parts_count">[docs]</a>    <span class="k">def</span> <span class="nf">get_file_parts_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Counts the number of file block blocks owned by the HiveNode</span>
<span class="sd">        for a given file identifier.</span>

<span class="sd">        Args:</span>
<span class="sd">             fid:</span>
<span class="sd">                An identifier of the file caller wishes to count.</span>
<span class="sd">        Returns:</span>
<span class="sd">            The number of file block blocks from the named file the HiveNode</span>
<span class="sd">            instance possesses.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="p">{}))</span></div>

<div class="viewcode-block" id="Node.get_status"><a class="viewcode-back" href="../../../app.domain.html#app.domain.network_nodes.Node.get_status">[docs]</a>    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Used to obtain the status of the worker.</span>

<span class="sd">        This method simulates a ping. When invoked, the HiveNode instance</span>
<span class="sd">        decides if it should switch its status from ONLINE to some other</span>
<span class="sd">        depending on the time it has been active in the Cluster.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The status of the worker. See</span>
<span class="sd">            :py:class:`domain.helpers.enums.e.Status`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">e</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">ONLINE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uptime</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uptime</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">OFFLINE</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span></div>
    <span class="c1"># endregion</span>

    <span class="c1"># region Python dunder methods&#39; overrides</span>
<div class="viewcode-block" id="Node.__hash__"><a class="viewcode-back" href="../../../app.domain.html#app.domain.network_nodes.Node.__hash__">[docs]</a>    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Can use Node instance or id as dictionary key.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span></div>

<div class="viewcode-block" id="Node.__eq__"><a class="viewcode-back" href="../../../app.domain.html#app.domain.network_nodes.Node.__eq__">[docs]</a>    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Node equality is based solely on HiveNode id.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">other</span></div>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span></div>
    <span class="c1"># endregion</span>


<div class="viewcode-block" id="HiveNode"><a class="viewcode-back" href="../../../app.domain.html#app.domain.network_nodes.HiveNode">[docs]</a><span class="k">class</span> <span class="nc">HiveNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents a network node that executes a Swarm Guidance algorithm.</span>

<span class="sd">    Workers work in one or more cluster_groups</span>
<span class="sd">    (:py:class:`domain.cluster_groups.Cluster`) to try to ensure the</span>
<span class="sd">    durability of files belonging to the distributed backup system. Their</span>
<span class="sd">    route file block blocks to other network_nodes at every epoch</span>
<span class="sd">    time according to the routing table of the file that block belongs to,</span>
<span class="sd">    i.e., according to the column vector of the transition matrix that is</span>
<span class="sd">    generated by</span>
<span class="sd">    (:py:meth:`domain.cluster_groups.Cluster.new_transition_matrix`).</span>
<span class="sd">    If every worker in the Cluster shares their blocks with other members by</span>
<span class="sd">    following their respective vector then eventually, the whole</span>
<span class="sd">    Cluster will reach the desired steady state distribution of file</span>
<span class="sd">    block blocks (:py:attr:`domain.cluster_groups.Cluster.v_`).</span>

<span class="sd">    Attributes:</span>
<span class="sd">        hives:</span>
<span class="sd">            A collection of :py:class:`domain.cluster_groups.Cluster` this</span>
<span class="sd">            HiveNode is a member of.</span>
<span class="sd">        routing_table:</span>
<span class="sd">            Contains the information required to appropriately route file</span>
<span class="sd">            block blocks to other HiveNode instances.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="HiveNode.__init__"><a class="viewcode-back" href="../../../app.domain.html#app.domain.network_nodes.HiveNode.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">uptime</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Instantiates a HiveNode object.</span>

<span class="sd">        Workers are the network nodes responsible for persisting file block</span>
<span class="sd">        blocks.</span>

<span class="sd">        Args:</span>
<span class="sd">            uid:</span>
<span class="sd">                An unique identifier for the worker instance.</span>
<span class="sd">            uptime:</span>
<span class="sd">                The availability of the worker instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">uptime</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hives</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">th</span><span class="o">.</span><span class="n">ClusterType</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routing_table</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span></div>

    <span class="c1"># region Simulation steps</span>
<div class="viewcode-block" id="HiveNode.execute_epoch"><a class="viewcode-back" href="../../../app.domain.html#app.domain.network_nodes.HiveNode.execute_epoch">[docs]</a>    <span class="k">def</span> <span class="nf">execute_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cluster</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">ClusterType</span><span class="p">,</span> <span class="n">fid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Instructs the HiveNode instance to execute the epoch.</span>

<span class="sd">        The method iterates all file block blocks in :py:attr:`files` and</span>
<span class="sd">        independently decides if they should be sent to other HiveNode</span>
<span class="sd">        instances by following :py:attr:`routing_table` column vectors.</span>

<span class="sd">        When a file block is sent to some other HiveNode a reply is</span>
<span class="sd">        awaited. In real world environments this should be assynchronous,</span>
<span class="sd">        but for simulation purposes it&#39;s synchronous and instantaneous. When the</span>
<span class="sd">        destination replies with OK, meaning it accepted the replica,</span>
<span class="sd">        this HiveNode instance deletes the replica from his disk. If it</span>
<span class="sd">        replies with a BAD_REQUEST the replica is discarded and the worker</span>
<span class="sd">        starts a recovery process in the Cluster. Any other code response</span>
<span class="sd">        results in the HiveNode instance keeping replica in his disk</span>
<span class="sd">        for at least one more epoch times. See</span>
<span class="sd">        :py:class:`domain.helpers.enums.HttpCodes` for more information on</span>
<span class="sd">        possible HTTP Codes.</span>

<span class="sd">        Overrides:</span>
<span class="sd">            :py:meth:`app.domain.network_nodes.Node.execute_epoch`.</span>

<span class="sd">        Args:</span>
<span class="sd">            cluster:</span>
<span class="sd">                Cluster instance that ordered execution of the epoch.</span>
<span class="sd">            fid:</span>
<span class="sd">                The identifier that determines which file blocks</span>
<span class="sd">                blocks should be routed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_view</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">ReplicasDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">number</span><span class="p">,</span> <span class="n">replica</span> <span class="ow">in</span> <span class="n">file_view</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">replicate_part</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">replica</span><span class="p">)</span>
            <span class="n">destination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_destination</span><span class="p">(</span><span class="n">replica</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">response_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_part</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">replica</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response_code</span> <span class="o">==</span> <span class="n">e</span><span class="o">.</span><span class="n">HttpCodes</span><span class="o">.</span><span class="n">OK</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">discard_part</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">response_code</span> <span class="o">==</span> <span class="n">e</span><span class="o">.</span><span class="n">HttpCodes</span><span class="o">.</span><span class="n">BAD_REQUEST</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">discard_part</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">corrupt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cluster</span><span class="o">=</span><span class="n">cluster</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">response_code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_replies</span><span class="p">:</span>
                <span class="n">cluster</span><span class="o">.</span><span class="n">complain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">response_code</span><span class="p">)</span></div>
            <span class="c1"># Else keep file part for at least one more epoch</span>
    <span class="c1"># endregion</span>

    <span class="c1"># region File block management</span>
<div class="viewcode-block" id="HiveNode.replicate_part"><a class="viewcode-back" href="../../../app.domain.html#app.domain.network_nodes.HiveNode.replicate_part">[docs]</a>    <span class="k">def</span> <span class="nf">replicate_part</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cluster</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">ClusterType</span><span class="p">,</span> <span class="n">replica</span><span class="p">:</span> <span class="n">sd</span><span class="o">.</span><span class="n">FileBlockData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Tries to restore the `replica`&#39;s</span>
<span class="sd">        :py:const:`~environment_settings.REPLICATION_LEVEL`.</span>

<span class="sd">        The file block replica is sent selectively in descending order to the</span>
<span class="sd">        most reliable Nodes in the Cluster down to the least</span>
<span class="sd">        reliable. Whereas</span>
<span class="sd">        :py:meth:`app.domain.network_nodes.HiveNode.send_part`. follows</span>
<span class="sd">        stochastic swarm guidance routing.</span>

<span class="sd">        Overrides:</span>
<span class="sd">            :py:meth:`app.domain.network_nodes.Node.replicate_part`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Number of times the block needs to be replicated.</span>
        <span class="n">lost_replicas</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">replica</span><span class="o">.</span><span class="n">can_replicate</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lost_replicas</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sorted_members</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">cluster</span><span class="o">.</span><span class="n">v_</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">destination</span> <span class="ow">in</span> <span class="n">sorted_members</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">lost_replicas</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">code</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">route_part</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">replica</span><span class="p">,</span> <span class="n">fresh_replica</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="n">e</span><span class="o">.</span><span class="n">HttpCodes</span><span class="o">.</span><span class="n">OK</span><span class="p">:</span>
                    <span class="n">lost_replicas</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="n">replica</span><span class="o">.</span><span class="n">references</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">suspicious_replies</span><span class="p">:</span>
                    <span class="n">cluster</span><span class="o">.</span><span class="n">complain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
            <span class="c1"># replication level may have not been completely restored</span>
            <span class="n">replica</span><span class="o">.</span><span class="n">update_epochs_to_recover</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">)</span></div>
    <span class="c1"># endregion</span>

    <span class="c1"># region Routing table management</span>
<div class="viewcode-block" id="HiveNode.set_file_routing"><a class="viewcode-back" href="../../../app.domain.html#app.domain.network_nodes.HiveNode.set_file_routing">[docs]</a>    <span class="k">def</span> <span class="nf">set_file_routing</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">fid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">transition_vector</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Maps a file id with a transition column vector used for routing.</span>

<span class="sd">        Args:</span>
<span class="sd">            fid:</span>
<span class="sd">                The identifier of the file the Cluster is persisting.</span>
<span class="sd">            transition_vector:</span>
<span class="sd">                A column vector with probabilities that dictate the odds of</span>
<span class="sd">                sending file block blocks belonging to the file with</span>
<span class="sd">                specified id to other Cluster members also working on the</span>
<span class="sd">                persistence of the file block blocks.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError:</span>
<span class="sd">                If ``transition_vector`` is not a pandas DataFrame and cannot</span>
<span class="sd">                be directly converted to it.</span>

<span class="sd">    &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transition_vector</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">routing_table</span><span class="p">[</span><span class="n">fid</span><span class="p">]</span> <span class="o">=</span> <span class="n">transition_vector</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transition_vector</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">routing_table</span><span class="p">[</span><span class="n">fid</span><span class="p">]</span> <span class="o">=</span> <span class="n">transition_vector</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;set_file_routing method expects a pandas.Series &quot;</span><span class="p">,</span>
                             <span class="s2">&quot;or pandas.DataFrame as transition vector type.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="HiveNode.remove_file_routing"><a class="viewcode-back" href="../../../app.domain.html#app.domain.network_nodes.HiveNode.remove_file_routing">[docs]</a>    <span class="k">def</span> <span class="nf">remove_file_routing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Removes a file id from the routing table.</span>

<span class="sd">        This method is called when a HiveNode is evicted from the Cluster</span>
<span class="sd">        and results in the complete deletion of all file blocks with that</span>
<span class="sd">        file id.</span>

<span class="sd">        Args:</span>
<span class="sd">            fid:</span>
<span class="sd">                Id of the file whose routing information is being</span>
<span class="sd">                removed from routing_table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routing_table</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="p">{})</span></div>
    <span class="c1"># endregion</span>

    <span class="c1"># region Swarm guidance</span>
<div class="viewcode-block" id="HiveNode.select_destination"><a class="viewcode-back" href="../../../app.domain.html#app.domain.network_nodes.HiveNode.select_destination">[docs]</a>    <span class="k">def</span> <span class="nf">select_destination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Selects a random message destination according to `routing_table`</span>
<span class="sd">        probabilities for the specified file name.</span>

<span class="sd">        Args:</span>
<span class="sd">            fid:</span>
<span class="sd">                The unique file identifier.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The name or address of the selected destination.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">routing_vector</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">routing_table</span><span class="p">[</span><span class="n">fid</span><span class="p">]</span>
        <span class="n">hive_members</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">routing_vector</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="n">member_chances</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">routing_vector</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">hive_members</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">member_chances</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">vE</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">routing_vector</span><span class="si">}</span><span class="se">\n</span><span class="s2">Stochastic?: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">member_chances</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span>
                    <span class="n">etype</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">vE</span><span class="p">),</span> <span class="n">value</span><span class="o">=</span><span class="n">vE</span><span class="p">,</span> <span class="n">tb</span><span class="o">=</span><span class="n">vE</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)))</span></div></div>
    <span class="c1"># endregion</span>


<div class="viewcode-block" id="HiveNodeExt"><a class="viewcode-back" href="../../../app.domain.html#app.domain.network_nodes.HiveNodeExt">[docs]</a><span class="k">class</span> <span class="nc">HiveNodeExt</span><span class="p">(</span><span class="n">HiveNode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents a network node that executes a Swarm Guidance algorithm.</span>

<span class="sd">    HiveNodeExt instances differ from HiveNode in the sense that the</span>
<span class="sd">    :py:class:`HiveClusterExt Nodes &lt;domain.domain.HiveNode&gt;` do not monitor their</span>
<span class="sd">    groups&#39; peers, concerning suspicious behaviors.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># region Get methods</span>
<div class="viewcode-block" id="HiveNodeExt.get_status"><a class="viewcode-back" href="../../../app.domain.html#app.domain.network_nodes.HiveNodeExt.get_status">[docs]</a>    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Used to obtain the status of the worker.</span>

<span class="sd">        Overrides:</span>
<span class="sd">            :py:meth:`app.domain.network_nodes.HiveNode.get_epoch_status`.</span>
<span class="sd">            When not ONLINE the node sets itself as Suspect and will only become</span>
<span class="sd">            offline when the monitor marks him as so (e.g.: due to complaints).</span>

<span class="sd">        Returns:</span>
<span class="sd">            The status of the worker. See</span>
<span class="sd">            :py:class:`app.domain.helpers.enums.Status`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">e</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">ONLINE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uptime</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uptime</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    [x] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> now offline (suspect status).&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">SUSPECT</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span></div></div>
    <span class="c1"># endregion</span>


<div class="viewcode-block" id="HDFSNode"><a class="viewcode-back" href="../../../app.domain.html#app.domain.network_nodes.HDFSNode">[docs]</a><span class="k">class</span> <span class="nc">HDFSNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents a data node in the Hadoop Distribute File System.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="HDFSNode.__init__"><a class="viewcode-back" href="../../../app.domain.html#app.domain.network_nodes.HDFSNode.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">uptime</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Instantiates a HDFSNode object.</span>

<span class="sd">        These represent hadoop distributed file system data nodes.</span>

<span class="sd">        Args:</span>
<span class="sd">            uid:</span>
<span class="sd">                An unique identifier for the worker instance.</span>
<span class="sd">            uptime:</span>
<span class="sd">                The availability of the worker instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">uptime</span><span class="p">)</span></div>

    <span class="c1"># region Simulation steps</span>
<div class="viewcode-block" id="HDFSNode.execute_epoch"><a class="viewcode-back" href="../../../app.domain.html#app.domain.network_nodes.HDFSNode.execute_epoch">[docs]</a>    <span class="k">def</span> <span class="nf">execute_epoch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cluster</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">ClusterType</span><span class="p">,</span> <span class="n">fid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Instructs the Node instance to execute the epoch.</span>

<span class="sd">        The method iterates all file block blocks in :py:attr:`~files` and</span>
<span class="sd">        silentry tries to corrupt them. In HDFS files&#39; Sha256 is only</span>
<span class="sd">        verified when a user or client accesses the remote replica. Thus,</span>
<span class="sd">        no recovery epoch is not setted up when a corruption occurs. The</span>
<span class="sd">        corruption is still logged in the output file.</span>

<span class="sd">        Overrides:</span>
<span class="sd">            :py:meth:`app.domain.network_nodes.Node.execute_epoch`.</span>

<span class="sd">        Args:</span>
<span class="sd">            cluster:</span>
<span class="sd">                Cluster instance that ordered execution of the epoch.</span>
<span class="sd">            fid:</span>
<span class="sd">                The identifier that determines which file blocks</span>
<span class="sd">                blocks should be routed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_view</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">ReplicasDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">number</span><span class="p">,</span> <span class="n">replica</span> <span class="ow">in</span> <span class="n">file_view</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">replicate_part</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span> <span class="n">replica</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">TRUE_FALSE</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">cluster</span><span class="o">.</span><span class="n">corruption_chances</span><span class="p">):</span>
                <span class="c1"># Don&#39;t set corrupt flag to True, doing so causes</span>
                <span class="c1"># set_recovery_epoch to be called. HDFS Corruption is silent.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">discard_part</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>
                <span class="c1"># Log the corruption in output file.</span>
                <span class="n">epoch</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">current_epoch</span>
                <span class="n">cluster</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">log_corrupted_file_blocks</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span></div>
    <span class="c1"># endregion</span>

    <span class="c1"># region File block management</span>
<div class="viewcode-block" id="HDFSNode.replicate_part"><a class="viewcode-back" href="../../../app.domain.html#app.domain.network_nodes.HDFSNode.replicate_part">[docs]</a>    <span class="k">def</span> <span class="nf">replicate_part</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">cluster</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">ClusterType</span><span class="p">,</span> <span class="n">replica</span><span class="p">:</span> <span class="n">sd</span><span class="o">.</span><span class="n">FileBlockData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Tries to restore the `replica`&#39;s</span>
<span class="sd">        :py:const:`~environment_settings.REPLICATION_LEVEL`.</span>

<span class="sd">        The file block replica is sent selectively in descending order to the</span>
<span class="sd">        most reliable Nodes in the Cluster down to the least reliable.</span>

<span class="sd">        Overrides:</span>
<span class="sd">            :py:meth:`app.domain.network_nodes.Node.replicate_part`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Number of times the block needs to be replicated.</span>
        <span class="n">lost_replicas</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">replica</span><span class="o">.</span><span class="n">can_replicate</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lost_replicas</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">choices</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">cluster</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
            <span class="n">choices</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">node</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">uptime</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">destination</span> <span class="ow">in</span> <span class="n">choices</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">lost_replicas</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">code</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">route_part</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">replica</span><span class="p">,</span> <span class="n">fresh_replica</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="n">e</span><span class="o">.</span><span class="n">HttpCodes</span><span class="o">.</span><span class="n">OK</span><span class="p">:</span>
                    <span class="n">lost_replicas</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="n">replica</span><span class="o">.</span><span class="n">references</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># replication level may have not been completely restored</span>
            <span class="n">replica</span><span class="o">.</span><span class="n">update_epochs_to_recover</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">current_epoch</span><span class="p">)</span></div>
    <span class="c1"># endregion</span>

    <span class="c1"># region Get Methods</span>
<div class="viewcode-block" id="HDFSNode.get_status"><a class="viewcode-back" href="../../../app.domain.html#app.domain.network_nodes.HDFSNode.get_status">[docs]</a>    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Used to obtain the status of the worker.</span>

<span class="sd">        Overrides:</span>
<span class="sd">            :py:meth:`app.domain.network_nodes.HiveNode.get_epoch_status`.</span>
<span class="sd">            When not ONLINE the node sets itself as Suspect and will only become</span>
<span class="sd">            offline when the monitor marks him as so (e.g.: due to complaints).</span>

<span class="sd">        Returns:</span>
<span class="sd">            The status of the worker. See</span>
<span class="sd">            :py:class:`app.domain.helpers.enums.Status`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">e</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">ONLINE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uptime</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uptime</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    [x] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> now offline (suspect status).&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">SUSPECT</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span></div></div>
    <span class="c1"># endregion</span>
</pre></div>

            </div>

        </section>

        

        
            <div class="source-link">
            
                
            
            </div>
        



    </main>

    <footer class="site-footer">
<div class="container">

    <div role="contentinfo">
        <p>
                &copy; Copyright 2020, Francisco Barros.
        </p>
    </div>
        <p>Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
        <a href="https://github.com/testthedocs/sphinx_ttd_theme">theme</a>
        provided by <a href="https://testthedocs">TestTheDocs</a>. 

</div>
</footer>

    

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'',
            VERSION:'1.6.0rc1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../../_static/js/theme-min.js"></script> 
</body>
</html>